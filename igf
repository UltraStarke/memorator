import  telebot
from telebot import types
import requests
import random
import os.path
import sqlite3
from  PIL import Image, ImageDraw, ImageFont
from distutils.command.check import check
from pyatspi.state import stateset_init, StateSet, StateSet_getStates
from itertools import count

bot = telebot.TeleBot('token')
states = []


def file_save(file_id, user_id): #save users image into the users folder
    file_info = bot.get_file(file_id) 
    downloaded_file = bot.download_file(file_info.file_path)
    with open(str(user_id)+'/'+str(image_counter(user_id))+".jpg", 'wb') as new_file:
        new_file.write(downloaded_file)
        
def frame_draw(im,txt):
    hgt = int(im.height)
    wdt = int(im.width*0.9)
    frame = Image.new('RGBA', (wdt, hgt), 'black')
    hgt = int(im.height*1.01)
    wdt = int(im.width*1.01)
    white_frame = Image.new('RGBA', (wdt, hgt), 'white')
    white_frame.thumbnail((white_frame.height, white_frame.width))
    im.thumbnail((im.height,im.width))
    i_h = int((white_frame.height-im.height)/2)
    i_w = int((white_frame.width-im.width)/2)
    white_frame.paste(im,(i_h,i_w))
    indent = int((frame.width-white_frame.width)/2)
    frame.paste(white_frame,(indent,indent))
    return text_draw(frame, txt)

def check_states(user_id):
    if len(states) > 0:
        for i in states:
            if i[0] == str(user_id):
                return True
    return False    
def find_states(user_id):
    counter = 0
    if len(states) > 0:
        for i in states:
            if i[0] == str(user_id):
                return counter 
            else:
                counter += 1
    return False

def image_counter(user_id):#count how many files contains users folder 
    num_files = len([f for f in os.listdir(str(user_id))
                     if os.path.isfile(os.path.join(str(user_id), f))])
    return(num_files)

def text_draw(im,txt):#write the text 
    fnt_size = int(im.width/(len(txt)*0.7))#calculate font size
    if fnt_size > im.height*0.15:
        fnt_size = int(im.height*0.15)
    elif fnt_size < im.height*0.03:
        fnt_size = int(im.height*0.03)
    if len(txt)*fnt_size*0.6 > im.width:
        check = False
        head_txt = ''
        tail_txt = ''
        while check == False:
            slice_txt = txt.rfind(' ')
            head_txt = txt[0:slice_txt]
            print(head_txt,'\n')
            tail_txt = txt[(slice_txt):len(txt)]+tail_txt
            print(tail_txt,'\n')
            if len(head_txt)*fnt_size*0.6 < im.width:
                check = True
                txt = head_txt+'\n'+tail_txt
                print(txt,'\n')
            else:
                txt = head_txt
                
    x = int(im.width/10)
    y = int(im.height-im.height*0.15)
    strk = int(fnt_size*0.02)#some manipulation to receive text stroke 
    fnt = ImageFont.truetype('mem_font.ttf',size = fnt_size)
    draw = ImageDraw.Draw(im)
    draw.text((x+strk,y-strk),txt,font = fnt, fill = (0,0,0))
    draw.text((x+strk,y+strk),txt,font = fnt, fill = (0,0,0))
    draw.text((x-strk,y+strk),txt,font = fnt, fill = (0,0,0))
    draw.text((x-strk,y-strk),txt,font = fnt, fill = (0,0,0))
    draw.text((x,y),txt,font = fnt, fill = (255,255,255))
    return im

@bot.message_handler(content_types=['text'])
def get_text_messages(message):
    keyboard  = types.InlineKeyboardMarkup()
    button_demo = types.InlineKeyboardButton('Demotivator',callback_data = "demotivator")
    button_sign = types.InlineKeyboardButton('Sign', callback_data = "sign")
    keyboard.add(button_demo, button_sign)
    if len(message.text)>64:
        bot.send_message(message.from_user.id,"Please write text less than 64 characters")
    else:
    
        if os.path.exists(str(message.from_user.id)):
            path = str(os.getcwd())+'/'+str(message.from_user.id)+'/'
            mem = Image.open(path+str(image_counter(message.from_user.id)-1)+'.jpg')
            if check_states(message.from_user.id):
                if states[find_states(message.from_user.id)][1] == 'sign':
                    bot.send_photo(message.from_user.id, text_draw(mem,message.text),reply_markup=keyboard)
                else:
                    bot.send_photo(message.from_user.id, frame_draw(mem,message.text),reply_markup=keyboard)
            else:
                states.append([str(message.from_user.id),'sign','white','black'])
                bot.send_photo(message.from_user.id, text_draw(mem,message.text),reply_markup=keyboard)
        else:
            bot.send_message(message.from_user.id,"You haven't send any images yet")

@bot.callback_query_handler(func=lambda call: call.data == 'demotivator')
def demo_choose(callback_query: types.CallbackQuery):
    bot.send_message(callback_query.from_user.id, 'You choose demotivator')
    global states 
    states[find_states(callback_query.from_user.id)][1] = 'demo'
    
@bot.callback_query_handler(func=lambda call: call.data == 'sign')
def sign_choose(callback_query: types.CallbackQuery):
    bot.send_message(callback_query.from_user.id, 'You choose sign')
    global states 
    states[find_states(callback_query.from_user.id)][1] = 'sign'
 
@bot.message_handler(content_types=['photo'])
def photo(message):
    if os.path.exists(str(message.from_user.id)): #check if the user has a folder, and if not create one  
        file_save(message.photo[-1].file_id,message.from_user.id)
        global states
        states.append([str(message.from_user.id),'sign','white','black'])
    else:
        os.mkdir(str(message.from_user.id))
        file_save(message.photo[-1].file_id,message.from_user.id)
        
    bot.send_message(message.from_user.id,'Enter the text you want to add to the image')
    
@bot.message_handler(content_types=['audio','document'])
def other_files(message):
    bot.send_message(message.from_user.id,"I don't eat that i'm not a goat")
            
bot.polling(none_stop=True, interval=0)
